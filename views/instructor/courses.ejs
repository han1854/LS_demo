<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Management - Instructor Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: calc(100vh - 64px);
        }
        .sidebar { background: #f8f9fa; padding: 1rem; border-right: 1px solid #dee2e6; }
        .main-content { padding: 2rem; }
        .course-card { border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 1rem; }
        .course-header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; }
        .course-body { padding: 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
        .stat-item { text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 2rem auto; padding: 2rem; border-radius: 8px; }
    </style>
</head>
<body>
    <nav class="nav-menu">
        <div class="logo">LearnSpace</div>
        <div class="nav-links">
            <a href="/instructor/dashboard">Dashboard</a>
            <a href="/instructor/courses" class="active">Courses</a>
            <a href="/instructor/analytics">Analytics</a>
            <a href="#" onclick="Auth.logout()">Logout</a>
        </div>
    </nav>

    <div class="dashboard-grid">
        <div class="sidebar">
            <button onclick="showNewCourseModal()" class="btn" style="width:100%">Create New Course</button>
            <div style="margin-top:2rem">
                <h4>Quick Stats</h4>
                <div style="margin-top:1rem">
                    <div>Total Students: <span id="totalStudents">0</span></div>
                    <div>Total Revenue: <span id="totalRevenue">$0</span></div>
                    <div>Active Courses: <span id="activeCourses">0</span></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <h2>My Courses</h2>
            <div id="coursesList"><!-- Courses will be loaded here --></div>
        </div>
    </div>

    <!-- New Course Modal -->
    <div id="newCourseModal" class="modal">
        <div class="modal-content">
            <h3>Create New Course</h3>
            <form id="newCourseForm" class="form">
                <div class="form-group">
                    <label>Course Title</label>
                    <input type="text" id="courseTitle" required>
                </div>
                <div class="form-group">
                    <label>Short Description</label>
                    <input type="text" id="courseShortDesc" required>
                </div>
                <div class="form-group">
                    <label>Full Description</label>
                    <textarea id="courseDesc" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="courseCategory" required></select>
                </div>
                <div class="form-group">
                    <label>Level</label>
                    <select id="courseLevel" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price ($)</label>
                    <input type="number" id="coursePrice" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Thumbnail</label>
                    <input type="file" id="courseThumbnail" accept="image/*">
                </div>
                <div style="margin-top:1rem">
                    <button type="submit" class="btn">Create Course</button>
                    <button type="button" class="btn" onclick="hideNewCourseModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Course Editor Modal -->
    <div id="courseEditorModal" class="modal">
        <div class="modal-content">
            <h3>Edit Course</h3>
            <div class="tabs">
                <button class="tab active" onclick="showTab('details')">Details</button>
                <button class="tab" onclick="showTab('curriculum')">Curriculum</button>
                <button class="tab" onclick="showTab('pricing')">Pricing</button>
            </div>
            <div id="detailsTab" class="tab-content">
                <form id="courseEditForm" class="form"><!-- fields --></form>
            </div>
            <div id="curriculumTab" class="tab-content" style="display:none">
                <button onclick="addSection()" class="btn">Add Section</button>
                <div id="curriculumEditor" class="curriculum-editor"></div>
            </div>
            <div id="pricingTab" class="tab-content" style="display:none">
                <form id="coursePricingForm" class="form">
                    <div class="form-group">
                        <label>Price ($)</label>
                        <input type="number" id="editCoursePrice" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="courseIsFree"> Make this course free</label>
                    </div>
                    <button type="submit" class="btn">Update Pricing</button>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        const token = Auth.getToken();
        const user = Auth.getUser();
        if (!token || !user || (user.Role !== 'instructor' && user.Role !== 'admin')) {
            location.href = '/login';
        }

        async function loadCourses() {
            try {
                const courses = await Api.fetchWithAuth('/api/courses/instructor', 'GET', token);
                const html = courses.map(course => `
                    <div class="course-card">
                        <div class="course-header">
                            <h3>${course.Title}</h3>
                            <div>
                                <button onclick="editCourse('${course.CourseID}')" class="btn">Edit</button>
                                <button onclick="previewCourse('${course.CourseID}')" class="btn">Preview</button>
                            </div>
                        </div>
                        <div class="course-body">
                            <p>${course.ShortDescription || ''}</p>
                            <div class="stats-grid">
                                <div class="stat-item"><div class="value">${course.EnrollmentCount || 0}</div><div class="label">Students</div></div>
                                <div class="stat-item"><div class="value">$${course.Revenue || 0}</div><div class="label">Revenue</div></div>
                                <div class="stat-item"><div class="value">${course.Rating ? course.Rating.toFixed(1) : 'N/A'}</div><div class="label">Rating</div></div>
                                <div class="stat-item"><div class="value">${course.CompletionRate || 0}%</div><div class="label">Completion</div></div>
                            </div>
                            <div style="margin-top:1rem">
                                <button onclick="manageLessons('${course.CourseID}')" class="btn">Manage Content</button>
                                <button onclick="viewAnalytics('${course.CourseID}')" class="btn">Analytics</button>
                                ${!course.IsPublished ? 
                                    `<button onclick="publishCourse('${course.CourseID}')" class="btn">Publish</button>` : 
                                    `<button onclick="unpublishCourse('${course.CourseID}')" class="btn">Unpublish</button>`
                                }
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('coursesList').innerHTML = html;
                const stats = await Api.fetchWithAuth('/api/instructors/stats', 'GET', token);
                document.getElementById('totalStudents').textContent = stats.totalStudents;
                document.getElementById('totalRevenue').textContent = '$' + stats.totalRevenue;
                document.getElementById('activeCourses').textContent = stats.activeCourses;
            } catch(err) {
                console.error('Failed to load courses:', err);
            }
        }

        function showNewCourseModal() { document.getElementById('newCourseModal').style.display = 'block'; loadCategories(); }
        function hideNewCourseModal() { document.getElementById('newCourseModal').style.display = 'none'; }

        async function loadCategories() {
            const categories = await Api.fetchWithAuth('/api/categories', 'GET', token);
            document.getElementById('courseCategory').innerHTML = categories.map(c => `<option value="${c.CategoryID}">${c.Name}</option>`).join('');
        }

        function manageLessons(courseId) { location.href = '/instructor/lessons?courseId=' + courseId; }
        function viewAnalytics(courseId) { location.href = '/instructor/analytics?courseId=' + courseId; }

        loadCourses();
    </script>
</body>
</html>
